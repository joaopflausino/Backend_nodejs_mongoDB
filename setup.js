// ==================================================
// SCRIPT DE CRIA√á√ÉO DO BANCO MONGODB
// Nome do Banco: microblogging
// Projeto: Sistema de Microblogging com An√°lise de Sentimento
// ==================================================

const { MongoClient } = require('mongodb');

// Configura√ß√£o da conex√£o
const url = 'mongodb://localhost:27017';
const dbName = 'microblogging';

async function setupDatabase() {
    const client = new MongoClient(url);
    
    try {
        // 1. Conectar ao banco de dados
        console.log('üîå Conectando ao MongoDB...');
        await client.connect();
        console.log('‚úÖ Conectado ao MongoDB com sucesso!');
        
        const db = client.db(dbName);
        
        // ==================================================
        // 2. CRIA√á√ÉO DAS COLE√á√ïES COM VALIDA√á√ÉO DE SCHEMA
        // ==================================================
        
        console.log('\nüìù Criando cole√ß√µes com valida√ß√£o de schema...');
        
        // ---- COLE√á√ÉO: users ----
        try {
            await db.createCollection("users", {
                validator: {
                    $jsonSchema: {
                        bsonType: "object",
                        required: ["username", "email"],
                        properties: {
                            username: {
                                bsonType: "string",
                                minLength: 3,
                                maxLength: 30,
                                description: "Username deve ter entre 3-30 caracteres e √© obrigat√≥rio"
                            },
                            email: {
                                bsonType: "string",
                                pattern: "^[a-zA-Z0-9._%+-]+@[a-zA-Z0-9.-]+\\.[a-zA-Z]{2,}$",
                                description: "Email deve ter formato v√°lido e √© obrigat√≥rio"
                            },
                            displayName: {
                                bsonType: "string",
                                maxLength: 50,
                                description: "Nome para exibi√ß√£o"
                            },
                            bio: {
                                bsonType: "string",
                                maxLength: 500,
                                description: "Biografia limitada a 500 caracteres"
                            },
                            profilePicture: {
                                bsonType: "string",
                                description: "URL da foto de perfil"
                            },
                            verified: {
                                bsonType: "bool",
                                description: "Conta verificada"
                            },
                            followers: {
                                bsonType: "int",
                                minimum: 0,
                                description: "N√∫mero de seguidores"
                            },
                            following: {
                                bsonType: "int",
                                minimum: 0,
                                description: "N√∫mero de pessoas seguindo"
                            },
                            postsCount: {
                                bsonType: "int",
                                minimum: 0,
                                description: "N√∫mero total de posts"
                            },
                            createdAt: {
                                bsonType: "date",
                                description: "Data de cria√ß√£o da conta"
                            },
                            updatedAt: {
                                bsonType: "date",
                                description: "Data da √∫ltima atualiza√ß√£o"
                            },
                            isActive: {
                                bsonType: "bool",
                                description: "Conta ativa ou n√£o"
                            }
                        }
                    }
                }
            });
            console.log('‚úÖ Cole√ß√£o "users" criada com sucesso');
        } catch (error) {
            if (error.code === 48) {
                console.log('‚ÑπÔ∏è  Cole√ß√£o "users" j√° existe');
            } else {
                throw error;
            }
        }
        
        // ---- COLE√á√ÉO: posts ----
        try {
            await db.createCollection("posts", {
                validator: {
                    $jsonSchema: {
                        bsonType: "object",
                        required: ["userId", "content"],
                        properties: {
                            userId: {
                                bsonType: "objectId",
                                description: "ID do autor (refer√™ncia para users)"
                            },
                            content: {
                                bsonType: "string",
                                maxLength: 280,
                                minLength: 1,
                                description: "Conte√∫do do post (m√°ximo 280 caracteres)"
                            },
                            images: {
                                bsonType: "array",
                                items: {
                                    bsonType: "string"
                                },
                                description: "Array de URLs de imagens"
                            },
                            hashtags: {
                                bsonType: "array",
                                items: {
                                    bsonType: "string"
                                },
                                description: "Array de hashtags"
                            },
                            mentions: {
                                bsonType: "array",
                                items: {
                                    bsonType: "objectId"
                                },
                                description: "Array de IDs de usu√°rios mencionados"
                            },
                            likes: {
                                bsonType: "int",
                                minimum: 0,
                                description: "N√∫mero de curtidas"
                            },
                            retweets: {
                                bsonType: "int",
                                minimum: 0,
                                description: "N√∫mero de retweets"
                            },
                            comments: {
                                bsonType: "int",
                                minimum: 0,
                                description: "N√∫mero de coment√°rios"
                            },
                            sentiment: {
                                bsonType: "object",
                                required: ["sentiment", "confidence"],
                                properties: {
                                    sentiment: {
                                        bsonType: "string",
                                        enum: ["positive", "negative", "neutral"],
                                        description: "Classifica√ß√£o do sentimento"
                                    },
                                    confidence: {
                                        bsonType: "double",
                                        minimum: 0,
                                        maximum: 1,
                                        description: "Confian√ßa da an√°lise (0 a 1)"
                                    },
                                    scores: {
                                        bsonType: "object",
                                        properties: {
                                            positive: {
                                                bsonType: "int",
                                                minimum: 0,
                                                description: "Contagem de palavras positivas"
                                            },
                                            negative: {
                                                bsonType: "int",
                                                minimum: 0,
                                                description: "Contagem de palavras negativas"
                                            },
                                            neutral: {
                                                bsonType: "int",
                                                minimum: 0,
                                                description: "Contagem de palavras neutras"
                                            }
                                        }
                                    },
                                    analyzedAt: {
                                        bsonType: "date",
                                        description: "Data da an√°lise"
                                    }
                                }
                            },
                            originalPost: {
                                bsonType: "objectId",
                                description: "Post original (para retweets)"
                            },
                            isRetweet: {
                                bsonType: "bool",
                                description: "Se √© um retweet"
                            },
                            createdAt: {
                                bsonType: "date",
                                description: "Data de cria√ß√£o"
                            },
                            updatedAt: {
                                bsonType: "date",
                                description: "Data de atualiza√ß√£o"
                            },
                            isDeleted: {
                                bsonType: "bool",
                                description: "Se foi deletado"
                            }
                        }
                    }
                }
            });
            console.log('‚úÖ Cole√ß√£o "posts" criada com sucesso');
        } catch (error) {
            if (error.code === 48) {
                console.log('‚ÑπÔ∏è  Cole√ß√£o "posts" j√° existe');
            } else {
                throw error;
            }
        }
        
        // ---- COLE√á√ÉO: userrelationships ----
        try {
            await db.createCollection("userrelationships", {
                validator: {
                    $jsonSchema: {
                        bsonType: "object",
                        required: ["follower", "following"],
                        properties: {
                            follower: {
                                bsonType: "objectId",
                                description: "ID do usu√°rio que segue"
                            },
                            following: {
                                bsonType: "objectId",
                                description: "ID do usu√°rio que √© seguido"
                            },
                            createdAt: {
                                bsonType: "date",
                                description: "Data que come√ßou a seguir"
                            },
                            isActive: {
                                bsonType: "bool",
                                description: "Relacionamento ativo"
                            }
                        }
                    }
                }
            });
            console.log('‚úÖ Cole√ß√£o "userrelationships" criada com sucesso');
        } catch (error) {
            if (error.code === 48) {
                console.log('‚ÑπÔ∏è  Cole√ß√£o "userrelationships" j√° existe');
            } else {
                throw error;
            }
        }
        
        // ---- COLE√á√ÉO: postinteractions ----
        try {
            await db.createCollection("postinteractions", {
                validator: {
                    $jsonSchema: {
                        bsonType: "object",
                        required: ["userId", "postId", "type"],
                        properties: {
                            userId: {
                                bsonType: "objectId",
                                description: "ID do usu√°rio que interagiu"
                            },
                            postId: {
                                bsonType: "objectId",
                                description: "ID do post"
                            },
                            type: {
                                bsonType: "string",
                                enum: ["like", "retweet", "comment"],
                                description: "Tipo de intera√ß√£o"
                            },
                            comment: {
                                bsonType: "object",
                                properties: {
                                    content: {
                                        bsonType: "string",
                                        maxLength: 280,
                                        description: "Conte√∫do do coment√°rio"
                                    },
                                    sentiment: {
                                        bsonType: "object",
                                        properties: {
                                            sentiment: {
                                                bsonType: "string",
                                                enum: ["positive", "negative", "neutral"]
                                            },
                                            confidence: {
                                                bsonType: "double",
                                                minimum: 0,
                                                maximum: 1
                                            },
                                            analyzedAt: {
                                                bsonType: "date"
                                            }
                                        }
                                    }
                                }
                            },
                            createdAt: {
                                bsonType: "date",
                                description: "Data da intera√ß√£o"
                            }
                        }
                    }
                }
            });
            console.log('‚úÖ Cole√ß√£o "postinteractions" criada com sucesso');
        } catch (error) {
            if (error.code === 48) {
                console.log('‚ÑπÔ∏è  Cole√ß√£o "postinteractions" j√° existe');
            } else {
                throw error;
            }
        }
        
        // ---- COLE√á√ÉO: logs (para tratamento de erros) ----
        try {
            await db.createCollection("logs", {
                validator: {
                    $jsonSchema: {
                        bsonType: "object",
                        required: ["level", "message", "timestamp"],
                        properties: {
                            level: {
                                bsonType: "string",
                                enum: ["error", "warning", "info", "debug"],
                                description: "N√≠vel do log"
                            },
                            message: {
                                bsonType: "string",
                                description: "Mensagem do log"
                            },
                            context: {
                                bsonType: "object",
                                description: "Contexto adicional (dados do erro, etc.)"
                            },
                            stackTrace: {
                                bsonType: "string",
                                description: "Stack trace do erro"
                            },
                            timestamp: {
                                bsonType: "date",
                                description: "Data e hora do log"
                            },
                            userId: {
                                bsonType: "objectId",
                                description: "ID do usu√°rio relacionado (opcional)"
                            },
                            action: {
                                bsonType: "string",
                                description: "A√ß√£o que gerou o log"
                            },
                            method: {
                                bsonType: "string",
                                description: "M√©todo/fun√ß√£o que gerou o log"
                            }
                        }
                    }
                }
            });
            console.log('‚úÖ Cole√ß√£o "logs" criada com sucesso');
        } catch (error) {
            if (error.code === 48) {
                console.log('‚ÑπÔ∏è  Cole√ß√£o "logs" j√° existe');
            } else {
                throw error;
            }
        }
        
        // ==================================================
        // 3. CRIA√á√ÉO DOS √çNDICES
        // ==================================================
        
        console.log('\nüîç Criando √≠ndices para melhor performance...');
        
        // √çndices para users
        try {
            await db.collection('users').createIndex({ "username": 1 }, { unique: true, name: "idx_username_unique" });
            console.log('‚úÖ √çndice √∫nico para username criado');
        } catch (error) {
            if (error.code === 85) {
                console.log('‚ÑπÔ∏è  √çndice username j√° existe');
            } else {
                throw error;
            }
        }
        
        try {
            await db.collection('users').createIndex({ "email": 1 }, { unique: true, name: "idx_email_unique" });
            console.log('‚úÖ √çndice √∫nico para email criado');
        } catch (error) {
            if (error.code === 85) {
                console.log('‚ÑπÔ∏è  √çndice email j√° existe');
            } else {
                throw error;
            }
        }
        
        await db.collection('users').createIndex({ "createdAt": -1 }, { name: "idx_users_created" });
        await db.collection('users').createIndex({ "isActive": 1 }, { name: "idx_users_active" });
        
        // √çndices para posts
        await db.collection('posts').createIndex({ "userId": 1, "createdAt": -1 }, { name: "idx_posts_user_date" });
        await db.collection('posts').createIndex({ "hashtags": 1 }, { name: "idx_posts_hashtags" });
        await db.collection('posts').createIndex({ "sentiment.sentiment": 1 }, { name: "idx_posts_sentiment" });
        await db.collection('posts').createIndex({ "createdAt": -1 }, { name: "idx_posts_date" });
        await db.collection('posts').createIndex({ "isDeleted": 1 }, { name: "idx_posts_deleted" });
        await db.collection('posts').createIndex({ "mentions": 1 }, { name: "idx_posts_mentions" });
        await db.collection('posts').createIndex({ "originalPost": 1 }, { name: "idx_posts_original" });
        await db.collection('posts').createIndex({ "content": "text" }, { name: "idx_posts_content_text" });
        
        // √çndices para userrelationships
        try {
            await db.collection('userrelationships').createIndex(
                { "follower": 1, "following": 1 }, 
                { unique: true, name: "idx_relationship_unique" }
            );
            console.log('‚úÖ √çndice √∫nico para relacionamentos criado');
        } catch (error) {
            if (error.code === 85) {
                console.log('‚ÑπÔ∏è  √çndice relacionamento j√° existe');
            } else {
                throw error;
            }
        }
        
        await db.collection('userrelationships').createIndex({ "following": 1 }, { name: "idx_following" });
        await db.collection('userrelationships').createIndex({ "follower": 1 }, { name: "idx_follower" });
        
        // √çndices para postinteractions
        try {
            await db.collection('postinteractions').createIndex(
                { "userId": 1, "postId": 1, "type": 1 }, 
                { unique: true, name: "idx_interaction_unique" }
            );
            console.log('‚úÖ √çndice √∫nico para intera√ß√µes criado');
        } catch (error) {
            if (error.code === 85) {
                console.log('‚ÑπÔ∏è  √çndice intera√ß√£o j√° existe');
            } else {
                throw error;
            }
        }
        
        await db.collection('postinteractions').createIndex({ "postId": 1, "type": 1 }, { name: "idx_post_interactions" });
        await db.collection('postinteractions').createIndex({ "userId": 1, "type": 1 }, { name: "idx_user_interactions" });
        await db.collection('postinteractions').createIndex({ "createdAt": -1 }, { name: "idx_interactions_date" });
        
        // √çndices para logs
        await db.collection('logs').createIndex({ "timestamp": -1 }, { name: "idx_logs_timestamp" });
        await db.collection('logs').createIndex({ "level": 1 }, { name: "idx_logs_level" });
        await db.collection('logs').createIndex({ "userId": 1 }, { name: "idx_logs_user" });
        await db.collection('logs').createIndex({ "action": 1 }, { name: "idx_logs_action" });
        
        console.log('‚úÖ Todos os √≠ndices criados com sucesso');
        
        // ==================================================
        // 4. INSER√á√ÉO DE DADOS DE EXEMPLO (OPCIONAL)
        // ==================================================
        
        console.log('\nüìä Inserindo dados de exemplo...');
        
        // Verificar se j√° existem usu√°rios
        const userCount = await db.collection('users').countDocuments();
        
        if (userCount === 0) {
            // Usu√°rios de exemplo
            const user1 = await db.collection('users').insertOne({
                username: "joao_dev",
                email: "joao@microblog.com",
                displayName: "Jo√£o Developer",
                bio: "Desenvolvedor apaixonado por tecnologia e an√°lise de sentimento",
                verified: false,
                followers: 0,
                following: 0,
                postsCount: 0,
                createdAt: new Date(),
                updatedAt: new Date(),
                isActive: true
            });
            
            const user2 = await db.collection('users').insertOne({
                username: "maria_tech",
                email: "maria@microblog.com",
                displayName: "Maria Tech",
                bio: "Entusiasta de IA e Machine Learning aplicado a redes sociais",
                verified: true,
                followers: 0,
                following: 0,
                postsCount: 0,
                createdAt: new Date(),
                updatedAt: new Date(),
                isActive: true
            });
            
            const user3 = await db.collection('users').insertOne({
                username: "carlos_data",
                email: "carlos@microblog.com",
                displayName: "Carlos Data",
                bio: "Cientista de dados especializado em an√°lise de sentimento",
                verified: false,
                followers: 0,
                following: 0,
                postsCount: 0,
                createdAt: new Date(),
                updatedAt: new Date(),
                isActive: true
            });
            
            console.log('‚úÖ Usu√°rios de exemplo criados');
            
            // Posts de exemplo com diferentes sentimentos
            const posts = [
                {
                    userId: user1.insertedId,
                    content: "Meu primeiro post no microblog! Muito animado com este projeto incr√≠vel üòä #nodejs #mongodb",
                    hashtags: ["nodejs", "mongodb"],
                    mentions: [],
                    likes: 0,
                    retweets: 0,
                    comments: 0,
                    sentiment: {
                        sentiment: "positive",
                        confidence: 0.9,
                        scores: { positive: 3, negative: 0, neutral: 0 },
                        analyzedAt: new Date()
                    },
                    isRetweet: false,
                    createdAt: new Date(),
                    updatedAt: new Date(),
                    isDeleted: false
                },
                {
                    userId: user2.insertedId,
                    content: "Que frustra√ß√£o com esses bugs... o sistema est√° terr√≠vel hoje üò§",
                    hashtags: [],
                    mentions: [],
                    likes: 0,
                    retweets: 0,
                    comments: 0,
                    sentiment: {
                        sentiment: "negative",
                        confidence: 0.85,
                        scores: { positive: 0, negative: 2, neutral: 0 },
                        analyzedAt: new Date()
                    },
                    isRetweet: false,
                    createdAt: new Date(Date.now() - 3600000), // 1 hora atr√°s
                    updatedAt: new Date(Date.now() - 3600000),
                    isDeleted: false
                },
                {
                    userId: user3.insertedId,
                    content: "Hoje foi um dia normal de trabalho. Nada muito especial aconteceu.",
                    hashtags: [],
                    mentions: [],
                    likes: 0,
                    retweets: 0,
                    comments: 0,
                    sentiment: {
                        sentiment: "neutral",
                        confidence: 0.7,
                        scores: { positive: 0, negative: 0, neutral: 2 },
                        analyzedAt: new Date()
                    },
                    isRetweet: false,
                    createdAt: new Date(Date.now() - 7200000), // 2 horas atr√°s
                    updatedAt: new Date(Date.now() - 7200000),
                    isDeleted: false
                },
                {
                    userId: user1.insertedId,
                    content: "JavaScript √© uma linguagem fant√°stica! Amo resolver problemas complexos üíª",
                    hashtags: ["javascript", "programming"],
                    mentions: [],
                    likes: 0,
                    retweets: 0,
                    comments: 0,
                    sentiment: {
                        sentiment: "positive",
                        confidence: 0.95,
                        scores: { positive: 3, negative: 0, neutral: 0 },
                        analyzedAt: new Date()
                    },
                    isRetweet: false,
                    createdAt: new Date(Date.now() - 10800000), // 3 horas atr√°s
                    updatedAt: new Date(Date.now() - 10800000),
                    isDeleted: false
                }
            ];
            
            await db.collection('posts').insertMany(posts);
            console.log('‚úÖ Posts de exemplo criados');
            
        } else {
            console.log('‚ÑπÔ∏è  Dados de exemplo j√° existem no banco');
        }
        
        // Log de inicializa√ß√£o
        await db.collection('logs').insertOne({
            level: "info",
            message: "Banco de dados configurado com sucesso",
            context: {
                database: dbName,
                collections: ["users", "posts", "userrelationships", "postinteractions", "logs"],
                indexes: "Todos os √≠ndices criados",
                sampleData: "Dados de exemplo inseridos"
            },
            timestamp: new Date(),
            action: "database_setup",
            method: "setupDatabase"
        });
        
        // ==================================================
        // 5. VERIFICA√á√ÉO DAS COLE√á√ïES CRIADAS
        // ==================================================
        
        console.log('\nüìã === RESUMO DA CRIA√á√ÉO ===');
        console.log(`üóÑÔ∏è  Banco de dados: ${dbName}`);
        console.log('üìÅ Cole√ß√µes criadas:');
        
        const collections = await db.listCollections().toArray();
        collections.forEach(collection => {
            console.log(`   - ${collection.name}`);
        });
        
        console.log('\nüîç === VERIFICA√á√ÉO DOS √çNDICES ===');
        
        // Verificar √≠ndices das principais cole√ß√µes
        const userIndexes = await db.collection('users').indexes();
        console.log(`üìä √çndices na cole√ß√£o users (${userIndexes.length}):`);
        userIndexes.forEach(index => {
            console.log(`   - ${index.name}`);
        });
        
        const postIndexes = await db.collection('posts').indexes();
        console.log(`üìä √çndices na cole√ß√£o posts (${postIndexes.length}):`);
        postIndexes.forEach(index => {
            console.log(`   - ${index.name}`);
        });
        
        // Estat√≠sticas das cole√ß√µes
        console.log('\nüìà === ESTAT√çSTICAS DAS COLE√á√ïES ===');
        const userCount2 = await db.collection('users').countDocuments();
        const postCount = await db.collection('posts').countDocuments();
        const logCount = await db.collection('logs').countDocuments();
        
        console.log(`üë• Usu√°rios: ${userCount2}`);
        console.log(`üìù Posts: ${postCount}`);
        console.log(`üìã Logs: ${logCount}`);
        
        console.log('\n‚úÖ === CONFIGURA√á√ÉO CONCLU√çDA ===');
        console.log('üéâ Banco de dados pronto para uso!');
        console.log('‚úÖ Cole√ß√µes criadas com valida√ß√£o de schema');
        console.log('‚úÖ √çndices otimizados para performance');
        console.log('‚úÖ Dados de exemplo inseridos');
        console.log('‚úÖ Sistema de logs configurado');
        
        console.log('\nüöÄ === PR√ìXIMOS PASSOS ===');
        console.log('1. Execute: npm start');
        console.log('2. Ou execute: node index.js');
        console.log('3. Para exemplos avan√ßados: node examples/advanced-usage.js');
        console.log('4. Para testes simples: node test/simple-tests.js');
        
    } catch (error) {
        console.error('‚ùå Erro durante a configura√ß√£o do banco de dados:', error);
        throw error;
    } finally {
        // Fechar conex√£o
        await client.close();
        console.log('\nüîå Conex√£o com MongoDB fechada');
    }
}

// ==================================================
// 6. COMANDOS √öTEIS PARA VERIFICA√á√ÉO
// ==================================================

/*
COMANDOS √öTEIS PARA TESTAR NO MONGOSH:

// Conectar ao banco
mongosh "mongodb://localhost:27017/microblogging"

// Ver todas as cole√ß√µes
show collections

// Ver documentos de uma cole√ß√£o
db.users.find().pretty()
db.posts.find().pretty()
db.logs.find().pretty()

// Verificar √≠ndices
db.users.getIndexes()
db.posts.getIndexes()

// Estat√≠sticas da cole√ß√£o
db.users.stats()
db.posts.stats()

// Contar documentos
db.users.countDocuments()
db.posts.countDocuments()

// Buscar posts por sentimento
db.posts.find({"sentiment.sentiment": "positive"}).pretty()
db.posts.find({"sentiment.sentiment": "negative"}).pretty()

// Buscar posts por usu√°rio
db.posts.find({"userId": objectId.createFromHexString("...")}).pretty()

// Ver logs de erro
db.logs.find({"level": "error"}).pretty()

// Verificar valida√ß√£o de schema
db.runCommand({collMod: "users", validator: {}, validationLevel: "strict"})

*/

// Executar setup se este arquivo for chamado diretamente
if (require.main === module) {
    setupDatabase()
        .then(() => {
            console.log('\nüéä Setup do banco de dados conclu√≠do com sucesso!');
            process.exit(0);
        })
        .catch(error => {
            console.error('\nüí• Erro fatal no setup:', error);
            process.exit(1);
        });
}

module.exports = { setupDatabase };